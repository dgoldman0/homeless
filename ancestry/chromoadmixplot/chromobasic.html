<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gedmatch → Clean Table</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables + Buttons -->
  <link href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
  <style>
    body{background:#f7f8fb}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    table.dataTable thead th, table.dataTable tbody td{white-space:nowrap;text-align:center}
  </style>
</head>
<body>
  <div class="container py-5">
    <h1 class="mb-2 text-center">Gedmatch Data Formatter</h1>
    <p class="text-center text-muted mb-4">Paste the raw table exactly as Gedmatch provides (with the offset “Chr--> 1” header and spacer columns).</p>

    <label class="form-label fw-semibold">Paste data</label>
    <textarea id="inputData" rows="12" class="form-control mono mb-3"
      placeholder="Paste the Gedmatch table here..."></textarea>

    <div class="d-flex gap-2 mb-4">
      <button id="processBtn" class="btn btn-primary">Process Data</button>
      <button id="clearBtn" class="btn btn-outline-secondary">Clear</button>
    </div>

    <div class="table-responsive">
      <table id="resultTable" class="table table-striped table-bordered w-100">
        <thead></thead><tbody></tbody>
      </table>
    </div>
  </div>

  <!-- JS libs -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

  <script>
    // Prefer tabs; fall back to 2+ spaces. Keeps "Chr--> 1" intact.
    function smartSplit(line){
      if(line.includes("\t")) return line.split("\t");
      return line.split(/ {2,}/);
    }
    const cleanToken = t => (t ?? "").trim();

    function asPercentDisplay(x){
      if(!x || x === "-") return "0%";
      return x.includes("%") ? x.trim() : (x.trim() + "%");
    }
    const pctToNum = p => {
      const n = parseFloat(String(p).replace("%",""));
      return Number.isFinite(n) ? n : 0;
    };

    function parseGedmatch(raw){
      const lines = raw.split(/\r?\n/).filter(l => l.trim().length > 0);

      // Find header row (starts with "Population")
      const headerIdx = lines.findIndex(l => /^Population\b/i.test(l));
      const dataLines = headerIdx >= 0 ? lines.slice(headerIdx + 1) : lines;

      // Build rows: [label, ...values] while removing spacer columns
      const rows = [];
      for(const line of dataLines){
        const parts = smartSplit(line).map(cleanToken);

        if(parts.length === 0) continue;
        const head = parts[0];

        // Skip footer like "Nbr of SNPs eval:"
        if(/^nbr\s*of\s*snps/i.test(head)) continue;

        // Remove empty spacer tokens that Gedmatch inserts between columns
        const noSpacers = parts.filter((t,i) => !(i>0 && t===""));

        // First real token is population label; remainder are chromosome cells (with spacers removed)
        const label = noSpacers[0];
        const rawVals = noSpacers.slice(1);

        // Coerce to exactly 22 value slots by padding/truncating after spacer removal
        const vals = rawVals.map(asPercentDisplay);
        while(vals.length < 22) vals.push("0%");
        if(vals.length > 22) vals.length = 22;

        // All-zero row check (after '-'→0%)
        const nums = vals.map(pctToNum);
        if(nums.every(v => v === 0)) continue;

        rows.push({label, vals, nums});
      }

      // Drop all-zero columns across remaining rows
      const keep = Array(22).fill(false);
      rows.forEach(r => r.nums.forEach((v,i)=>{ if(v>0) keep[i]=true; }));
      const keptIdx = keep.map((k,i)=>k?i:-1).filter(i=>i>=0);

      // Build display rows with stats and only kept columns
      const outRows = rows.map(r => {
        const nums = keptIdx.map(i => r.nums[i]);
        const percs = keptIdx.map(i => r.vals[i]);

        const max = Math.max(...nums);
        const mean = nums.reduce((a,b)=>a+b,0) / nums.length;
        const cov  = nums.reduce((a,b)=>a + Math.pow(b-mean,2), 0) / nums.length;

        return [r.label, max.toFixed(2)+"%", mean.toFixed(2)+"%", cov.toFixed(2)+"%", ...percs];
      });

      // Header: Population, Max, Mean, Covariance, Chr 1..N (renumbered cleanly)
      const header = ["Population","Max","Mean","Covariance"];
      for(let i=1;i<=keptIdx.length;i++) header.push(`Chr ${i}`);

      return {header, data: outRows};
    }

    function renderTable({header,data}){
      if($.fn.DataTable.isDataTable("#resultTable")){
        $("#resultTable").DataTable().clear().destroy();
      }
      $("#resultTable thead").html("<tr>"+header.map(h=>`<th>${h}</th>`).join("")+"</tr>");
      $("#resultTable tbody").html(data.map(r=>"<tr>"+r.map(c=>`<td>${c}</td>`).join("")+"</tr>").join(""));

      $("#resultTable").DataTable({
        paging:true, searching:true, info:true, ordering:true, scrollX:true,
        dom:'Bfrtip',
        buttons:[
          {extend:'csvHtml5', title:'gedmatch_clean'},
          {extend:'excelHtml5', title:'gedmatch_clean'}
        ]
      });
    }

    document.getElementById("processBtn").addEventListener("click", ()=>{
      const raw = document.getElementById("inputData").value;
      const parsed = parseGedmatch(raw);
      renderTable(parsed);
    });

    document.getElementById("clearBtn").addEventListener("click", ()=>{
      document.getElementById("inputData").value = "";
      if($.fn.DataTable.isDataTable("#resultTable")){
        $("#resultTable").DataTable().clear().draw();
      }else{
        $("#resultTable thead").empty();
        $("#resultTable tbody").empty();
      }
    });
  </script>
</body>
</html>
